---
output:
  pdf_document
header-includes: \usepackage[french]{babel}
---

\newpage
\begin{flushright}
    \textbf{Équipe 8}
\end{flushright}

\begin{center}
    \vspace{2\baselineskip}
    Charles Comeau \\
    (111 185 421) \\
    \vspace{1\baselineskip}
    Nicholas Langevin \\
    (111 184 631) \\
    \vspace{1\baselineskip}
    Andréanne Larouche \\
    (111 190 518) \\
    \vspace{7\baselineskip}
    Apprentissage statistique en actuariat\\
    ACT-3114 \\
    \vspace{7\baselineskip}
    {\large
    \textbf{Analyse des données de renouvellement d'assurance}} \\
    \vspace{8\baselineskip}
    présenté à \\
    Marie-Pier Côté \\
    \vspace{9\baselineskip}
    École d’actuariat \\
    Université Laval \\
    27 février 2020
\end{center}

\newpage

\tableofcontents

```{R , echo = FALSE, include = FALSE, warning = FALSE}
library(CASdatasets)
library(ggplot2)
data(eudirectlapse)
data.init <- eudirectlapse

## Changement dans les donnees
data <- data.init
str(data)
data$lapse <- as.factor(data$lapse)
levels(data$lapse) <- c("renew", "cancelation")
data[data$polholder_diffdriver == "unknown", ]$polholder_diffdriver <- NA
data[data$vehicl_garage == "unknown", ]$vehicl_garage <- NA
data$prem_freqperyear <- factor(data$prem_freqperyear, order = TRUE, levels = c("1 per year", "2 per year", "4 per year", "12 per year"))

data$vehicl_powerkw_na <- data$vehicl_powerkw
data[data$vehicl_powerkw_na == "125-300 kW", ]$vehicl_powerkw_na <- NA
data[data$vehicl_powerkw %in% c("150 kW","175 kW","200 kW","225 kW","250 kW","275 kW","300 kW"), ]$vehicl_powerkw <- "125-300 kW"
data <- droplevels(data)
data$vehicl_powerkw <- factor(data$vehicl_powerkw, order = TRUE, levels = c("25-50 kW", "75 kW", "100 kW", "125-300 kW"))
table(data$vehicl_powerkw)
str(data)

## Diagramme à bande des frequence de renouvellement et decheance en fonction des variables categorielles 
ggplot(data, aes(x=lapse, fill=polholder_BMCevol))+
  geom_bar(position="dodge")
ggplot(data, aes(x=lapse, fill=polholder_diffdriver))+
  geom_bar(position="dodge")
ggplot(data, aes(x=lapse, fill=polholder_gender))+
  geom_bar(position="dodge")
ggplot(data, aes(x=lapse, fill=policy_caruse))+
  geom_bar(position="dodge")
ggplot(data, aes(x=lapse, fill=prem_freqperyear))+
  geom_bar(position="dodge")
ggplot(data, aes(x=lapse, fill=vehicl_garage))+
  geom_bar(position="dodge")
ggplot(data, aes(x=lapse, fill=vehicl_powerkw))+
  geom_bar(position="dodge")
ggplot(data, aes(x=lapse, fill=vehicl_region))+
  geom_bar(position="dodge")

```

\newpage

# Introduction

Les données qui seront analysées dans ce rapport proviennent du jeu de données "eudirectlapse" du paquetage "CASdatasets" de R. Dans le but de modéliser le statut de renouvellement d'une police d'assurance, il sera d'abord nécessaire de visualiser et de pré-traiter les données observées des 23 060 polices d'assurance. Il est à noter que la durée d'observation est de un an et que l'année visée et la compagnie demeurent inconnue. Ainsi, "lapse", variable de type catégorielle qui indique si l'assuré résignera lors de son renouvellement d'assurance ou non, est la variable réponse qui sera intéressante.

\newpage

# Analyse exploratoire des données

## lapse

La variable lapse représente si le client à abandonner sa police lors du renouvellement. Il s'agit de la variable eogène. Initialement, le choix du client était indiquer par une représensation binaire (À VÉRIFIER). Si le client désire résigner sa police lapse prenait la valeur 1, autrement elle prenait la valeur 0. À des fins de simplification nous avons converti la variable en variable catégorielle pour aider la visualisation pour la suite. La variable prendra maintenant la valeur "cancelation" si le client à décider de résigner et "renew" si il renouvelle la police d'assurance.Voici, un diagramme illustrant la répartition des choix des clients.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r graph_lapse, echo = FALSE, eval = TRUE, include = TRUE, warning = FALSE}
ggplot(data, aes(x=lapse))+
  geom_bar()
```
On constate qu'il y a 20106 clients qui ont renouveler alors qu'il y en a 2954 qui résigner leur du renouvellement. Il y a donc 12.81% des 23060 clients qui n'ont pas renouveler.


## polholder_age

Cette variable est une variable numérique discrète représentant l'âge du propriétaire de la police d'assurance. Voici un tableau de fréquence des âges des assurés.

```{r graph_polholder_age, echo = FALSE, eval = TRUE, include = TRUE, warning = FALSE}
ggplot(data, aes(x = polholder_age))+
  geom_bar()
```

L'âge minimal parmis les assuré est de 19 ans et l'âge maximal est de 85 ans. On constate qu'il y a une forte proportion d'assuré entre 25 et 60 ans.


## polholder_BMCevol



## polholder_diffdriver

Il s'agit d'une variable catégorielle nominale représentant la différence de statut qui pourrait avoir entre le propriétaire de la police et le conducteur principale.  

```{r graph_polholder_diffdriver, echo = FALSE, eval = TRUE, include = TRUE, warning = FALSE}
ggplot(data, aes(x = polholder_diffdriver))+
  geom_bar()
```

## polholder_gender

Variable catégorielle nomianle représentant le sexe du propriétaire de la police. Voici la répartition du sexe du propriétaire de la police d'assurance.

```{r graph_polholder_gender, echo = FALSE, eval = TRUE, include = TRUE, warning = FALSE}
ggplot(data, aes(x = polholder_gender))+
  geom_bar()
```

## polholder_job

Variable catégorielle nominale décrivant le travail du prorpiétaire du contrat. Deux valeurs sont possibles soit "medical" soit "normal". 

```{r graph_polholder_job, echo = FALSE, eval = TRUE, include = TRUE, warning = FALSE}
ggplot(data, aes(x = polholder_job))+
  geom_bar()
```

## policy_age

Variable numérique discrète représentant le nombre d'année sans résignation de la police d'assurance depuis la première année assurée. 

```{r graph_policy_age, echo = FALSE, eval = TRUE, include = TRUE, warning = FALSE}
ggplot(data, aes(x = policy_age))+
  geom_bar()
```

On constate une forte décroissance du nombre d'assurée pour le nombre d'années depuis l'entré en vigueur pour les  3 premières années pour ensuite ce stabilisé par la suite.

## policy_caruse

Variable catégorielle nominale représentant les fins d'utilisation du véhicule.     

```{r graph_policy_caruse, echo = FALSE, eval = TRUE, include = TRUE, warning = FALSE}
ggplot(data, aes(x = policy_caruse))+
  geom_bar()
```
On constate qu'il y a un nombre considérable de données manquantes et très peu de véhicule pour un usage commerciale.


## policy_nbcontract

Variable numérique discrète représentant le nombre de contrat que possède l'assuré chez l'assureur. 

```{r graph_policy_nbcontract, echo = FALSE, eval = TRUE, include = TRUE, warning = FALSE}
ggplot(data, aes(x = policy_nbcontract))+
  geom_bar()
```

L'histogramme illustre le fait qu'il y a une forte concentration d'assuré pour lesquels le nombre de contrat qu'ils ont chez l'assureur est inférieur à 5. On peut aussi voir que certains assurés ont jusqu'à 15 contrats.


## Les variables de primes

Il y a plusieurs variables numériques continues relatives à la prime. La variable prem_final re présente le montant de la prime proposé pour le renouvellement par l'assureur alors que prem_last représente le montant payé lors du dernier renouvellement. La variable prem_market est la prime qui serait chargée selon le marché. La variable prem_pure est la prime pure.    

```{r stats_prem, echo = FALSE, eval = TRUE, include = TRUE, warning = FALSE}
stats_final <- c(summary(data$prem_final)[c(1, 3, 4, 6)], sd(data$prem_final))

stats_last <- c(summary(data$prem_last)[c(1, 3, 4, 6)], sd(data$prem_last))

stats_market <- c(summary(data$prem_market)[c(1, 3, 4, 6)], sd(data$prem_market))

stats_pure <- c(summary(data$prem_pure)[c(1, 3, 4, 6)], sd(data$prem_pure))

tableau_stats <- rbind(stats_final, stats_last, stats_market, stats_pure)

dat_frame_tab <- as.data.frame(tableau_stats)

colnames(dat_frame_tab) <- c("Minimum", "Médiane", "Moyenne", "Maximum", "Écart-type")

```


## prem_freqperyear

Variable catégorielle ordinale représentant la fréquence par année à laquelle la prime est payable. Les fréquence possible est mensuelle, trimestrielle, semestrielle ou annuelle.

```{r graph_prem_freqperyear, echo = FALSE, eval = TRUE, include = TRUE, warning = FALSE}
ggplot(data, aes(x = prem_freqperyear))+
  geom_bar()
```
On voit qu'un peu moins de la moitié des clients paient la prime en un seul versement, environ un quart des clients paient trimestriellement, et le dernier quart est partagé par la prime payable semestriellement et mensuellement.


## Variables relatives à l'âge du véhicule

Les deux prochaines variables sont en lien avec l'aĝe du véhicule, il s'agit de variables numériques discrètes. La variable vehicl_agepurchase représente l'âge du véhicule lorsque l'assuré a acheté le véhicule. La variable vehicl_age représente l'aĝe du véhicule actuellement. 

```{r graph_age, echo = FALSE, eval = TRUE, include = TRUE, warning = FALSE}
library(gridExtra)
library(grid)
library(lattice)
age_vehicule <- ggplot(data, aes(x = vehicl_age))+
  geom_bar()

agepurchase_vehicule <- ggplot(data, aes(x = vehicl_agepurchase))+
  geom_bar()

grid.arrange(agepurchase_vehicule, age_vehicule,  ncol=2)

```

Beaucoup de véhicule ont été achetés lorsqu'il était neuf (vehicl_purchase = 0). En examinant les véhicules conduits par es assurés on remarque qu'il y a peu de véhicule neuf et le nombre de véhicule est croissant en fonction de l'utilisation jusqu'à 13 ans puis décroit par la suite. On retrouve un grand nombre de véhicule assuré avec 18 ans d'usage, il est fort probable que cela correspondre aux véhicules de plus de 18 ans. 


## vehicl_garage

Variable catégorielle nominale décrivant le type de stationnement de la voiture. Voici la répartition des types de stationnement.

```{r graph_vehicl_garage, echo = FALSE, eval = TRUE, include = TRUE, warning = FALSE}
ggplot(data, aes(x = vehicl_garage))+
  geom_bar() + theme(axis.text.x = element_text(angle = 90))
```

On voit que les moyens de stationnement les plus populaire sont le garage privé et la rue.


## 


\newpage

# Autres sections


\newpage

# Analyse en composantes principales
```{R , echo = FALSE, include = FALSE}
require(tidyverse)
require(FactoMineR)
require(factoextra)
require(plotly)
require(ggplot2)
library(cluster)
```

Étant donné que notre jeu de données contient `R nrow(Donnees_tempo)` observations, il peut être utile de visualiser les données à l'aide de l'analyse en composantes principales, appelé ACP. En effet, ce type d'analyse permet de mieux visualiser un jeu de données lorsque celui-ci est de grande dimension. Il sera ainsi possible de voir quelles variables explicatives sont plus intéressantes par leur impact sur la variance des composantes principales. Il est à noter qu'en général, on garde assez de composantes pour représenter entre 80 et 90 % de la variance totale. 

Pour que cette méthode de visualisation puisse être utilisée, il sera nécessaire de prendre seulement les variables explicatives numériques de ce jeu de donnée. Les variables catégorielles ne seront pas analysées dans cette section car même en les transformant en variables numériques, elles ne seront pas représentative de leur signification.

```{R , echo = FALSE, include = TRUE}
Donnees_tempo <- na.omit(data)
Data_num <- Donnees_tempo[, c("polholder_age", "policy_age", "policy_nbcontract", "prem_final", "prem_last", "prem_market", 
                              "prem_pure", "vehicl_age", "vehicl_agepurchase")]
```

On doit ensuite choisir le nombre de composantes principales. Cette étape peut être complétée en spécifiant le pourcentage de variance expliquée pour obtenir la cible précisée précedemment ou utiliser la méthode du coude sur le diagramme d'éboulis. 

```{R , echo = FALSE, include = FALSE}
ACP <- PCA(Data_num, scale = TRUE, ncp = 6)
```
À l'aide du graphique ACP des variables on peut observer que pour la première composante principlae, une valeur élevé indique un contrat ayant une prime élevé, que ce soit la prime du marché, la prime pure, la prime finale ou la prime chargée lors du dernier renouvellement. Par contre, un assuré âgé aura un score moindre qu'un assuré en bas âge. Un score élevé représente donc un assuré en bas âge ayant une prime élevé tandis qu'un score faible représente une personne plus âgée avec une faible prime d'assurance. 

La deuxième composante principale représente, quant à elle, l'âge du véhicule assuré. Un score élevé est associé à des véhicules de moindres valeurs mais risquant d'avantage un bris de veillesse. Plus les polices d'assurance sont récentes et plus le score en sera augmenté. Ainsi, les polices d'assurances récente ayant des véhicules de l'année représenteront les scores les plus faibles pour cette composante.

```{R , echo = FALSE, include = TRUE}
fviz_screeplot(ACP)
ACP$eig
```

Selon le diagramme d'éboulis, il sera nécessaire de conserver 6 composantes principales et on observe, à l'aide des valeurs propres de la matrice de corélation, que 6 composantes principales permettent d'expliquer 97% de la variance totale.

À l'aide de la fonction ACP, nous pouvons voir la gravité des contributions pour chacune des variables sur chacune des composantes principales retenu. Ainsi, on remarque que la variable *prem_final* est celle ayant la plus grande contribution sur la première composantes principale, tout comme les variable *prem_last*, *prem_market* et *prem_pure*. Quand à la deuxième et à la sixième composante principale, c'est les variables *vehicl_age* et *vehicl_agepurchase* qui fournissent la plus grande contribution. Les variables explicatives *polholder_age* et *policy_age* ont les contributions les plus importantes pour les troisième et cinquième composantes principales. Pour ce qui est de la variable *policy_nbcontract*, elle est la variable apportant la plus grande contribution sur la quatrième composante principale. 

```{R , echo = FALSE, include = TRUE}
ACP$var$contrib
```

En illustrant les contributions des variables pour chacune des composantes principales, il est plus facile de visualiser l'intensité de leur contribution.

```{R , message=FALSE, include = TRUE, echo = FALSE}
contrib <- data.frame(ACP$var$coord[,1:6])
contrib$carac <- rownames(contrib)
contrib.long <- reshape2::melt(contrib)

ggplot(contrib.long, aes(x=carac, fill=variable, y=value))+
  geom_bar(stat="identity",position=PositionDodge)+
  facet_grid(~variable)+
  theme(legend.position="top",axis.text.x = element_text(angle = 90))+
  coord_flip()
```


Diagramme de points (modèle) : À COMPLÉTER ET VÉRIFIER S'IL NE FAUT PAS INCLURE LES VARIABLES CATEGORIELLE ORDINALE TRANSFORMÉES EN VARIABLE NUMÉRQUES
```{R , echo = FALSE, include = TRUE}
data <- cbind(Donnees_tempo, ACP$ind$coord)

g_ind <- ggplot(data = data,
             aes(x= Dim.2, y=Dim.3, col = policy_age,  shape = lapse, labels = polholder_age,
                 alpha = 0.2)) +
  geom_point() +
  xlab("Dimension 2") +
  ylab("Dimension 3") +
  theme_bw()
ggplotly(g_ind) #Pour comparer les dimensions 2 et 3

g_ind <- ggplot(data = data,
             aes(x= Dim.1, y=Dim.2, col = prem_pure,  shape = lapse, labels = vehicl_agepurchase,
                 alpha = 0.2)) +
  geom_point() +
  xlab("Dimension 1") +
  ylab("Dimension 2") +
  theme_bw()
ggplotly(g_ind) #Pour comparer les dimensions 2 et 3
```

\newpage

# Partitionnement en k moyennes

Le partitionnement en k moyennes est utiliser pour classifier les observations en k groupes distincts. La valeur de k est une valeur qu'on transmet pour indiquer le nombre de partitions désirées. Chaque observation sera ensuite assigné à un seul groupe. L'algorithme utilisée pour ce type de partitionnement a pour objectif de minimiser la variance intra-groupe.

```{R , echo = FALSE, include = TRUE}
Data_num <- Donnees_tempo[, c("polholder_age", "policy_age", "policy_nbcontract", "prem_final", "prem_last", "prem_market", 
                              "prem_pure", "vehicl_age", "vehicl_agepurchase")]

K <- 3
kmoyennes <- kmeans(Data_num, K, nstart=5)
Donnees_acp <- PCA(Data_num, scale = FALSE, ncp = 2, graph = FALSE)

composante1 <- Donnees_acp$ind$coord[,1]
composante2 <- Donnees_acp$ind$coord[,2]

groupe <- as.factor(kmoyennes$cluster)

ggplot() + geom_point(aes(composante1, composante2, color = groupe)) + theme_minimal()
```

\newpage

# Conclusion


\newpage

# Annexe

Notre jeu de données représente le statut de renouvellement pour 23 060 polices d'assurance basées sur un an d'observation. Les données receuillies proviennent d'une compagnie d'assurance inconnue dont l'année d'observation est également inconnue.
